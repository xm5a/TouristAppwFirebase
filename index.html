<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Tourist Live Tracker</title>
    <style>
        /* FIX: Ensure the map container takes up the full viewport */
        html, body, #map {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>

<!-- FIX: Corrected style attribute formatting -->
<div id="map"></div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

    // --- FIREBASE CONFIGURATION (Using the config from your file) ---
    const firebaseConfig = {
        apiKey: "AIzaSyBmvrTANm1-jNwmeaMhpjq9JKTTAofcEWg",
        authDomain: "tourist-app-test-63310.firebaseapp.com",
        projectId: "tourist-app-test-63310",
        storageBucket: "tourist-app-test-63310.firebasestorage.app",
        messagingSenderId: "514944152276",
        appId: "1:514944152276:web:4f723294cbcaa8f7b10141",
        measurementId: "G-SFSQ0B034K"
    };

    // --- MAPLIBRE INITIALIZATION ---
    const map = new maplibregl.Map({
        style: 'https://tiles.openfreemap.org/styles/liberty',
        center: [13.388, 57.517],
        zoom: 9.5,
        container: 'map',
    });

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app); // Note: Analytics usually requires specific setup; we'll keep the variable for now.
    const db = getFirestore(app);
    let touristMarkers = {};
    
    // The path to your collection (Must match the Python backend)
    const TOURIST_COLLECTION_PATH = "tourists";

    /**
     * Updates or creates a MapLibre marker for a specific tourist.
     * @param {string} touristId - The ID of the tourist (Firestore document ID).
     * @param {number} lat - Latitude.
     * @param {number} lon - Longitude.
     */
    function updateMapMarker(touristId, lat, lon) { // Changed 'lng' parameter to 'lon' for clarity
        // MapLibre expects [longitude, latitude]
        const coordinates = [lon, lat]; 
        
        if (touristId in touristMarkers) {
            // Update existing marker position
            touristMarkers[touristId].setLngLat(coordinates);
        } else {
            // Create a new marker and Popup
            // FIX: Use backticks (`) for template literals in Popup text
            const marker = new maplibregl.Marker()
                .setLngLat(coordinates)
                .setPopup(new maplibregl.Popup({ offset: 25 }).setText(`Tourist ID: ${touristId}`))
                .addTo(map);
            
            touristMarkers[touristId] = marker;
            console.log(`New marker added for ${touristId} at [${lon}, ${lat}]`);
            map.flyTo({
            center: coordinates, // coordinates is [lon, lat]
            zoom: 12,           // Optional: Zoom in slightly when clicked
            speed: 1.5          // Optional: Speed of the animation
        });
        }
    }
    
    /**
     * Removes a map marker for a specific tourist ID.
     * @param {string} touristId - The ID of the tourist.
     */
    function removeMapMarker(touristId) {
        if (touristId in touristMarkers) {
            touristMarkers[touristId].remove();
            delete touristMarkers[touristId];
            console.log(`Marker removed for ${touristId}`);
        }
    }

    // --- REAL-TIME DATA LISTENER ---
    const touristCollection = collection(db, TOURIST_COLLECTION_PATH);
    
    onSnapshot(touristCollection, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const touristData = change.doc.data();
            const touristId = change.doc.id;
            const lat = touristData.latitude;
            const lon = touristData.longitude; // This is the variable name used below!
            
            // Check for valid data before proceeding
            if (typeof lat !== 'number' || typeof lon !== 'number') {
                console.error(`Invalid coordinates for ${touristId}: Lat=${lat}, Lon=${lon}`);
                return; 
            }

            if (change.type === "added" || change.type === "modified") {
                // CRITICAL FIX: The function call was using 'lng' which was undefined.
                // We use the correctly defined 'lon' variable here.
                updateMapMarker(touristId, lat, lon);
            } else if (change.type === "removed") {
                removeMapMarker(touristId);
            }
        });
    });
    
</script>

</body>

</html>

