<!DOCTYPE HTML>
<html>
<head>
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
</head>
<body>

<div id = "map" style = "width: 100% height: 100%"></div>

<script type="module">

 const map = new maplibregl.Map({
    style: 'https://tiles.openfreemap.org/styles/liberty',
	let userLat = position.coords.latitude;
	let userLon = position.coords.longitude;
    center: [userLon,userLat],
    zoom: 9.5,
    container: 'map',
  })

  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBmvrTANm1-jNwmeaMhpjq9JKTTAofcEWg",
    authDomain: "tourist-app-test-63310.firebaseapp.com",
    projectId: "tourist-app-test-63310",
    storageBucket: "tourist-app-test-63310.firebasestorage.app",
    messagingSenderId: "514944152276",
    appId: "1:514944152276:web:4f723294cbcaa8f7b10141",
    measurementId: "G-SFSQ0B034K"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  let touristMarkers = {};
  
  function updateMapMarker(touristId,lat,lng){
  const coordinates = [lng,lat];
  
  if(touristId in touristMarkers){
  touristMarkers[touristId].setLngLat(coordinates);
  }
  else{
  const marker = new maplibregl.Marker().setLngLat(coordinates).setPopup(new maplibregl.Popup({offset:25}).setText('Tourist Id: ${touristId}')).addTo(map);
  
  touristMarkers[touristId] = marker;
  }
  }
  
  function removeMapMarker(touristId){
  if (touristId in touristMarkers){
  touristMarkers[touristId].remove();
  delete touristMarkers[touristId];
  console.log('Marker removed for ${touristId}');
  }
  }
  const touristCollection = collection(db, "tourists");
  onSnapshot(touristCollection, (snapshot) => {
  snapshot.docChanges().forEach((change) => {
  const touristData = change.doc.data();
  const touristId = change.doc.id;
  const lat = touristData.latitude;
  const lon = touristData.longitude;
  
  if (change.type === "added" || change.type === "modified"){
  updateMapMarker(touristId,lat,lng);
  }
  else if (change.type === "removed"){
  removeMapMarker(touristId);
  }
  });
  });
  
</script>

</body>
</html>