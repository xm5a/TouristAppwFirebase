<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Tourist Live Tracker</title>
    <style>
        /* FIX: Ensure the map container takes up the full viewport */
        html, body, #map {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>

// ... (HTML Head and Body remain the same) ...

<div id="map"></div>
<script type = "module">
// --- FIREBASE IMPORTS ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

// --- FIREBASE CONFIGURATION (Using the config from your file) ---
const firebaseConfig = {
    apiKey: "AIzaSyBmvrTANm1-jNwmeaMhpjq9JKTTAofcEWg",
    authDomain: "tourist-app-test-63310.firebaseapp.com",
    projectId: "tourist-app-test-63310",
    storageBucket: "tourist-app-test-63310.firebasestorage.app",
    messagingSenderId: "514944152276",
    appId: "1:514944152276:web:4f723294cbcaa8f7b10141",
    measurementId: "G-SFSQ0B034K"
};

// --- MAPLIBRE UTILITIES ---

function calculateDistance(lat1, lat2, lon1, lon2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function createGeoCircle(center, radius, points = 64) {
    const coords = [];
    const earthRad = 6371e3;
    const lat = center.lat * Math.PI / 180;
    const lon = center.lng * Math.PI / 180;

    for (let i = 0; i <= points; i++) {
        const angle = (i * 360 / points) * Math.PI / 180;
        const dx = radius * Math.cos(angle);
        const dy = radius * Math.sin(angle);

        const latOff = lat + (dy / earthRad);
        const lonOff = lon + (dx / (earthRad * Math.cos(lat))); 

        coords.push([
            lonOff * 180 / Math.PI,
            latOff * 180 / Math.PI
        ]);
    }

    return {
        type: "Feature",
        geometry: {
            type: "Polygon",
            coordinates: [coords]
        }
    };
}

// --- GEOFENCE CONFIGURATION ---
const geofence = {
    lat: 19.207385364043382,
    lng: 72.98311549254477,
    radius: 50 // radius in meters
};
const geofenceCenter = {
    lat: geofence.lat,
    lng: geofence.lng,
};
    
// --- MAPLIBRE INITIALIZATION ---
const map = new maplibregl.Map({
    style: 'https://tiles.openfreemap.org/styles/liberty',
    center: [geofence.lng, geofence.lat], 
    zoom: 13, 
    container: 'map',
});

map.on('load', () => {
    map.addSource('MyHouse', {
        'type': 'geojson',
        'data': createGeoCircle(geofenceCenter, geofence.radius), 
    });

    map.addLayer({
        'id': 'MyHouse',
        'type': 'fill',
        'source': 'MyHouse',
        'layout': {},
        'paint': {
            'fill-color': '#088',
            'fill-opacity': 0.5, 
        }
    });
});

// --- FIREBASE INITIALIZATION ---
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app); 
const db = getFirestore(app);
// CRITICAL CHANGE: touristMarkers stores BOTH the Marker and the Popup instance.
const touristMarkers = {}; 
    
// The path to your collection (Must match the Python backend)
const TOURIST_COLLECTION_PATH = "tourists";

/**
 * Calculates geofence status and returns the status string.
 * @param {number} touristLat - Tourist Latitude.
 * @param {number} touristLon - Tourist Longitude.
 * @returns {string} The geofence status string.
 */
function getGeofenceStatus(touristLat, touristLon) {
    const distance = calculateDistance(touristLat, geofence.lat, touristLon, geofence.lng); 
    
    if (distance <= geofence.radius) {
        return `Inside GeoFence (${distance.toFixed(2)}m)`;
    } else {
        return `Outside Geofence (${distance.toFixed(2)}m)`;
    }
}


/**
 * Updates or creates a MapLibre marker and its associated popup for a specific tourist.
 * @param {string} touristId - The ID of the tourist (Firestore document ID).
 * @param {number} lat - Latitude.
 * @param {number} lon - Longitude.
 * @param {string} status - The status from the backend (ACTIVE, MISSING, etc.).
 */
function updateMapMarker(touristId, lat, lon, status) { 
    const coordinates = [lon, lat]; 
    
    // 1. Calculate the Geofence Status
    const geoFncPosStat = getGeofenceStatus(lat, lon);
    
    // 2. Combine the status for the popup text
    const popupText = 
        `Tourist ID: ${touristId}\n` +
        `Location: ${lat.toFixed(6)}, ${lon.toFixed(6)}\n` +
        `Geofence Status: ${geoFncPosStat}\n` +
        `API Status: ${status || 'N/A'}`; // Include API status from the backend
    
    if (touristId in touristMarkers) {
        // --- UPDATE EXISTING MARKER ---
        
        // A. Update Marker Position
        touristMarkers[touristId].marker.setLngLat(coordinates);
        
        // B. **CRITICAL FIX: Update the Popup text using the stored popup reference**
        touristMarkers[touristId].popup.setText(popupText);

        console.log(`Updated marker and popup for ${touristId}`);

    } else {
        // --- CREATE NEW MARKER ---
        
        // Create the Popup instance first
        const popup = new maplibregl.Popup({ offset: 25 }).setText(popupText);
        
        // Create the Marker instance and attach the popup
        const marker = new maplibregl.Marker({ color: status === 'MISSING' ? 'red' : 'blue' })
            .setLngLat(coordinates)
            .setPopup(popup) 
            .addTo(map);
            
        // 3. Store the Marker AND the Popup reference in the centralized object
        touristMarkers[touristId] = {
            marker: marker,
            popup: popup
        };
        
        console.log(`New marker added for ${touristId}`);
        map.flyTo({
            center: coordinates, 
            zoom: 14,             
            speed: 1.5            
        });
    }
}
    
/**
 * Removes a map marker for a specific tourist ID.
 * @param {string} touristId - The ID of the tourist.
 */
function removeMapMarker(touristId) {
    if (touristId in touristMarkers) {
        touristMarkers[touristId].marker.remove(); // Use the stored marker object
        delete touristMarkers[touristId];
        console.log(`Marker and popup removed for ${touristId}`);
    }
}

// --- REAL-TIME DATA LISTENER ---
const touristCollection = collection(db, TOURIST_COLLECTION_PATH);
    
onSnapshot(touristCollection, (snapshot) => {
    snapshot.docChanges().forEach((change) => {
        const touristData = change.doc.data();
        const touristId = change.doc.id;
        const lat = touristData.latitude;
        const lon = touristData.longitude; 
        const status = touristData.status; // Get the status from the backend

        if (change.type === "added" || change.type === "modified") {
            // Only update if we have valid coordinates
            if (typeof lat === 'number' && typeof lon === 'number') {
                updateMapMarker(touristId, lat, lon, status);
            } else {
                console.error(`Invalid coordinates for ${touristId}. Skipping update.`);
            }
        } else if (change.type === "removed") {
            removeMapMarker(touristId);
        }
    });
});
</script>
</body>

</html>
















